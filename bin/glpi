#!/usr/bin/env php
<?php

require_once __DIR__.'/../app/main.php';

define("MIGRATIONS_PATH", __DIR__."/app/database/migrations");
define("SEEDS_PATH", __DIR__."/app/database/seeds");
define("INSTALL_PATH", __DIR__."/app/install");

$__doc__ = <<<DOC
GLPI Setup

Usage: glpi <command>

Commands available:
    install     Create database and some additionnal directories.
    migrate     Check for new code version and migrate database accordingly.
    seed        Seed the database with fake data.

DOC;

/**
 * Script for creating, destroying, and seeding the app's database
 */
class Glpi {

    function __construct($doc)
    {
        $docopt = new Docopt\Handler();
        $this->args = $docopt->handle($doc);
    }

    function help()
    {
        echo "usage: php " . $this->args[0] . " <command> [<args>]\n";
    }

    function run()
    {
        switch ($this->args['<command>']) {
            case "migrate":
                $this->migrate();
            case "seed":
                $this->seed();
                break;
            case "install":
                $this->install();
                break;
        }
    }

    function migrate()
    {
        $files = glob(MIGRATIONS_PATH.'/*.php');

        foreach ($files as $file) {
            require_once $file;

            $name = basename($file, '.php');

            list($number,$class) = explode('_',$name);
            $migration = new $class;
            $migration->run();
        }
    }

    function seed()
    {
        require_once APP_PATH."/install/seed.php";
        $seed = new Seed();
        $seed->run();
    }


    function install() {
        // Make sure some directories are created (cf. /app/bootstrap/paths.php)
        $directories = [
            VAR_PATH,
            LOG_PATH,
        ];
        foreach( $directories as $directory ) {
            if (!file_exists($directory)) {
                mkdir($directory, 0777, true);
            }
        }

        // Create SQLITE database file if it doesn't exists
        global $configs;
        if (
            $configs['db']['driver'] === 'sqlite'
            and !file_exists($configs['db']['database'])
        ) {
            touch($configs['db']['database']);
        }

        require_once APP_PATH.'/install/install.php';

        $item = new GLPIInstall();
        $item->run();

    }

}

$glpi = new Glpi($__doc__);
$glpi->run();
